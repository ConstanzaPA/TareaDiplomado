---
title: "Evaluación de la dieta en la mortalidad del Salmón del Atlántico"
author: "Constanza Pino Ajenjo"
date: "`r Sys.Date()`"
output:
  beamer_presentation:
    theme: Malmoe
    colortheme: seahorse
    fonttheme: professionalfonts
    includes:
      in_header: mystyle.tex
      subtitle: Diplomado en Análisis de datos con R para la Acuicultura
institute: Pontificia Universidad Católica de Valparaíso
---

```{r setup, include=FALSE, comment=TRUE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readxl)
library(kableExtra)
library(pander)
library(DT)
library(gridExtra)
library(stats)
library(stats4)
library(car)

```


## Introducción

**Descripción del problema a resolver:** 

Completar introducción

Debido a su impacto en la salud de Salmón del Atlántico, es importante evaluar la influencia de la dieta en la mortalidad en los centros de cultivo en agua de mar.

**Objetivo:** 

Analizar si la dieta afecta la mortalidad de Salmón Atlántico en 136 jaulas (Unidad) en centros de agua mar durante los últimos 3 años.


## Análisis exploratorio de los datos

```{r Preparar datos, include=FALSE, comment=FALSE}

#Cargar la base de datos en el objeto Dietas:
Salar <- read_excel("Salar.xlsx", sheet=1,na="NA")
Salar <- na.omit(Salar)
head(Salar)

#Explorar si las variables son números o carácteres:
str(Salar)

#Transformar Unidad y Dieta a factor usando as.factor, luego visualizar que Unidad y Dieta estén transformados adecuadamente a factor y que los datos están balanceados:
Salar$Unidad <- as.factor(Salar$Unidad)
Salar$Dieta <- as.factor(Salar$Dieta)
summary(Salar)

```

**1.** **Balanceo de datos:**

1) Se filtran las dietas con mayor y similar número de n muestreal (BES1  y BS1).

2) Se calcula el porcentaje de mortalidad (P.Mortalidad) para utilizar como variable de estudio.

3) Se explora si las variables son números o carácteres y, luego se transforman las variables Unidad y Dieta en factores.

4) Se identifica que los datos estén balanceados usando una tabla de frecuencia de los datos.


## Análisis exploratorio de los datos

**2.** **Descripción de la variación de las variables:**

1) Histogramas: las tres variables exploradas no tienen distribución normal.

```{r Histogramas,warning=FALSE, message=FALSE, out.width = '70%', fig.align='center'}
#Observar el comportamiento de las variables en estudio usando histogramas y boxplot (valor atípico se muestra en punto de color rojo):

hist_ing <- ggplot(Salar,aes(Ingreso))+
  geom_histogram(fill="lightblue",color="black",bins=10)+
  labs(title = "Número de peces ingresados")

hist_peso <- ggplot(Salar,aes(Peso_cosecha))+
  geom_histogram(fill="lightblue",color="black",bins=8)+
  labs(title = "Peso promedio de cosecha")

hist_mort <- ggplot(Salar,aes(P.Mortalidad))+
  geom_histogram(fill="lightblue",color="black",bins=10)+
  labs(title = "Mortalidad")

grid.arrange(hist_ing, hist_peso, hist_mort, ncol=1, nrow =3)

```

## Análisis exploratorio de los datos

**2.** **Descripción de la variación de las variables:**

2) Boxplot de las variables por factor Unidad: 

```{r ,warning=FALSE, message=FALSE, out.width = '70%', fig.align='center'}

bi <-ggplot(data=Salar, aes(x=Unidad,y=Ingreso))+geom_boxplot()
bp <-ggplot(data=Salar, aes(x=Unidad,y=Peso_cosecha))+geom_boxplot()
bm <-ggplot(data=Salar, aes(x=Unidad,y=P.Mortalidad))+geom_boxplot()

grid.arrange(bi, bp, bm, ncol=1, nrow =3)

```


## Análisis exploratorio de los datos

**2.** **Descripción de la variación de las variables:**

3) Diagrama de caja y bigotes de las variables por factor Dieta: solo en el porcentaje de mortalidad según el tipo de dieta difieren las medianas y hay valores atípicos (puntos de color rojo).

```{r Boxplot variables por tipo de Dieta ,warning=FALSE, message=FALSE, out.width = '70%', fig.align='center'}

blot_ing <- ggplot(Salar,aes(y=Ingreso,x=Dieta))+
  geom_boxplot(fill="lightblue",outlier.colour = "red")+
  labs(y="Ingreso",x="Tipo de Dieta")

blot_peso <- ggplot(Salar,aes(y=Peso_cosecha,x=Dieta))+
  geom_boxplot(fill="lightblue",outlier.colour = "red")+
  labs(y="Peso cosecha",x="Tipo de Dieta")

blot_mort <- ggplot(Salar,aes(y=P.Mortalidad,x=Dieta))+
  geom_boxplot(fill="lightblue",outlier.colour = "red")+
  labs(y="% Mortalidad",x="Tipo de Dieta")

grid.arrange(blot_ing, blot_peso, blot_mort, ncol=1, nrow =3)

```


## Análisis exploratorio de los datos

**3.** **Determinar la relación entre variables y factores:**

1) Gráficos de interacción:

```{r Gráficos blot interacción ,warning=FALSE, message=FALSE, out.width = '70%', fig.align='center'}
#Establecer relación entre variables cuantitativas y factores usando gráficas de correlación, boxplot, interacción o de tamaño de los efectos:

ip1 <- interaction.plot(Salar$Unidad,Salar$Dieta, Salar$Peso_cosecha,trace.label="Dieta",fun=mean, xlab="Unidad",ylab="Peso cosecha",type="b", col= c("black", "blue"),pch=c(19,17))
 
ip2 <- interaction.plot(Salar$Unidad,Salar$Dieta, Salar$P.Mortalidad,trace.label="Dieta",fun=mean,xlab="Unidad",ylab=" % Mortalidad",type="b", col= c("black", "blue"),pch=c(19,17))

id1 <- plot.design(Salar$Peso_cosecha~Salar$Unidad*Salar$Dieta,xlab="Factores", ylab="Peso cosecha")
 
id2 <- plot.design(Salar$P.Mortalidad~Salar$Unidad*Salar$Dieta,xlab="Factores", ylab="% Mortalidad")

```



## Hipótesis

- **Hipótesis nula (H0):** ausencia de correlación entre la dieta y la mortalidad del Salmón del Atlántico. 

- **Hipotesis alternativa (H1):** existencia de correlación entre la dieta y la mortalidad. 



## Evaluación de los supuestos

Se determinan los siguientes supuestos:

1) Independencia de las varibales: las observaciones son independientes debido a que se obtienen de distintas jaulas.

2) Homocedasticidad: se evalua con gráfico de residuales versus ajustados (Residuals vs Fitted) en un modelo lineal.

3) Normalidad: en el histograma del porcentaje de mortalidad se observa que su distribución no es normal, ya que tiene distribución hacia la derecha. La normalidad también se determina con gráfico de cuantil-cuantil (Normal Q-Q) en un modelo lineal. 


## Evaluación de los supuestos

El gráfico de resisuales versus ajustados y de cuantil-cuantil del modelo lineal muestran que no se cumplen los supuestos de homocedasticidad y normalidad respectivamente.

```{r Grafico evaluación supuestos, warning=FALSE, message=FALSE, out.width = '70%', fig.align='center'}
# Gráfico de diagnóstico de un modelo lineal para evaluar la homocedasticidad y normalidad de los residuos

m1 = lm(Salar$P.Mortalidad ~ Salar$Dieta)
plot(m1)

```



## Análisis de datos

 Modelo lineal generalizado con distribución de Poisson y link Long

```{r Modelo lineal generalizado, warning=FALSE, message=FALSE, out.width = '50%', fig.align='center'}

m2 = glm(Salar$P.Mortalidad ~ Salar$Dieta, 
                family= poisson(link="log"))
summary(m2)

#Anova con Chi:
anova(m2, test ='Chisq')

```

## Prueba de correlación

Gráfico de coeficiente de correlación de t-test o Spearman:

```{r Gráfico correlación ,warning=FALSE, message=FALSE, out.width = '70%', fig.align='center'}

t.test(Salar$P.Mortalidad ~ Salar$Dieta, var.equal=TRUE, alternative = c("two.sided"))
#p value es menor a 0,05 entonces se rechaza la H0.



```


## Conclusión

- Se concluye que la hipotesis nula es aceptada, o sea, la dieta está asociada a la  mortalidad del Salmón del Atlántico.

- A partir de este análisis se puede estudiar cual tipo de dieta tiene mayor relación en la mortalidad, creando nuevas hipotésis y sometiendo a otros modelos estadísticos.

```{r}

```

